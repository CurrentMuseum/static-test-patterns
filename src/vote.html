<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Current Museum Acquisition Committee Voting App</title>

  
<style>
  
  body {
    font-family: helvetica;
  }
  
/* Vote Switch Styling */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {display:none;}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Table styling */
.table-wrapper {
  margin: 20px;
}
  
table#artwork-data {
  margin: 20px auto 80px auto;
}
  
td, th {
    padding: 5px 20px 5px 0px;
    vertical-align: top;
    text-align: left;
}
  
td.artwork-price {
  text-align: right;
}
  
td img {
    height: 100px
}

/* Submission */
  #budget-and-submit-wrapper {
    position: fixed;
    bottom: 0px;
    width: 100%;
    text-align: center;
    background-color: black;
    color: white;
  }
  
  #submit-vote {
    padding: 20px;
  }
  #submit-vote input {
    padding: 12px;
    margin-right: 5px;
    width: 50%;
  }
  
/* Misc. Styling */
body {
  margin: 0px;
  text-align: center;
}
.button {
    background-color: white; /* Green */
    border: none;
    color: black;
    padding: 12px 12px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
}
.button:hover {
  cursor:pointer;
}
  
</style>  

<script src="https://code.jquery.com/jquery-3.1.0.js"></script>

<script>

  var startingBudget = 20000, // set the initial budget available
      remainingBudget,
      lowestArtworkPrice,
      googleFormURL = 'https://script.google.com/macros/u/0/s/AKfycbwBz1uFAzkj5PXxs6mArqWoBG6EznsXL9ziY3gTUj8YJdzuX1hN/exec'; // 


  $('#submit-vote').toggle(); // hide the submission area until we vote
  countBudget(); // kick off the initial count

  $('#artwork-data input').click(function() {
    countBudget(this); // when a checkbox is clicked, calculate our remaining budget
  });

  $('#vote-button').on('click', function(e) {
    e.preventDefault();
    var vote = serializeVote();
    var jqxhr = $.ajax({
      url: googleFormURL,
      method: "GET",
      dataType: "json",
      data: vote,
      success: function() {
        console.log('success');
      }
    })
  })

  $( window ).load(function() {
    
  });

  function parseDollar(numText) {
    return parseFloat(numText.replace(/[^0-9-.]/g, '')); // 12345.99
  }
  function formatMoney(number, places, symbol, thousand, decimal) {
    places = !isNaN(places = Math.abs(places)) ? places : 2;
    symbol = symbol !== undefined ? symbol : "$";
    thousand = thousand || ",";
    decimal = decimal || ".";
    var negative = number < 0 ? "-" : "",
        i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
        j = (j = i.length) > 3 ? j % 3 : 0;
    return symbol + negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
  };

  function swapBudgetElements() {
    $('#submit-vote').toggle(); // allow the user to submit their vote
    $('#budget-remaining').toggle();
  }

  function getLowestPriceAvailableArtwork() {
    var artworkPrices = [];
    
    $('.results tr input[name*="artwork-acquire"]:not(:checked)').each(function (i, checkbox) { // only find lowest priced of the available artworks
      artworkPrice = parseDollar($(checkbox).closest('tr').find('.artwork-price').text()); // grab its price
      if (artworkPrice > 0) artworkPrices.push(artworkPrice);
    });

    lowestArtworkPrice = Math.min.apply(null, artworkPrices); // find the lowest art price to allow for submission of votes
  }

  function countBudget(clickedElement) {
    remainingBudget = startingBudget; // restart the budget calc with each clicke
    var artworkCost;
    
    getLowestPriceAvailableArtwork();
    
    $('.results tr input[name*="artwork-acquire"]:checked').each(function (i, checkbox) { // find all the checked
      artworkCost = parseDollar($(checkbox).closest('tr').find('.artwork-price').text()); // grab its price
      remainingBudget -= artworkCost; // adjust the remaining budget
    });
    
    if(remainingBudget < 0) { // we tried to over-spend
      $(clickedElement).prop('checked', false); // uncheck the artwork
      alert("There isn't enough budget left for that work");
      countBudget(clickedElement); // re-run the count budget logic
    } else if(remainingBudget < lowestArtworkPrice) { // we spent all the money
      swapBudgetElements();
    } else { // we can spend more
      $('.results tr input[name*="artwork-acquire"]:not(:checked)').each(function (i, checkbox) { // find all the artwork leftover
        $(checkbox).removeAttr('disabled'); // enable the buttons again
        if($('#submit-vote').is(':visible')) {
          swapBudgetElements(); // if we had the submit vote visible, then hide it again
        }
      });
    }

    if($('#budget-remaining').is(":visible")) {
      $('#budget-remaining').fadeOut(150, function() {
        $('#remaining-budget').text(formatMoney(remainingBudget, 0, "$", ",", ".")); // update the remaining budget
      }).fadeIn(150);
    }
    
  }

  function serializeVote() {
    var serializedVote = {};
    serializedVote.email = $('#email-input').val();
    
    $('.results tr input[name*="artwork-acquire"]:checked').each(function (i, checkbox) { // find all the artwork leftover
      serializedVote[($(checkbox).attr("artid"))] = 1;
    })
                                                                       
    return serializedVote;
  }



</script>

</head>
<body>
  <img src="http://www.current.mu/images/logo-01.svg" />
  <h2>Cast Your Vote</h2>
  
  <div id="budget-and-submit-wrapper">
    <div id="budget-remaining"><h3><span id="remaining-budget"></span> Budget Remaining</h3></div>
    <div id="submit-vote">
      <input type="text" placeholder="Enter Your Email" id="email-input">
      <span class="button" id="vote-button">VOTE</div>
    </div>
  </div>
  <div class="table-wrapper">
    <table id="artwork-data" class="data">
        <thead class="header">
            <tr>
                <th>Acquire</th>
                <th>Image</th>
                <th>Price</th>
                <!-- <th>Title</th> -->
                <th>Artist</th>
            </tr>
        </thead>
        <tbody class="results">
            <tr>
                <th>
                  <label class="switch">
                  <input type="checkbox" name="artwork-acquire" artid="artwork_1">
                  <span class="slider"></span>
                  </label>
                </th>
                <td><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg/687px-Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg"></td>
                <td class="artwork-price">$15,000</td>
                <!-- <td>Placeholder Title</td> -->
                <td>Leonardo da Vinci</td>
            </tr>
            <tr>
                <th>
                  <label class="switch">
                  <input type="checkbox" name="artwork-acquire" artid="artwork_2">
                  <span class="slider"></span>
                  </label>
                </th>
                <td><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg/687px-Mona_Lisa%2C_by_Leonardo_da_Vinci%2C_from_C2RMF_retouched.jpg"></td>
                <td class="artwork-price">$10,000</td>
                <!-- <td>Placeholder Title</td> -->
                <td>Leonardo da Vinci</td>
            </tr>
          

          

        </tbody>
    </table>
  </div>
</body>
</html>